sudo: required
language: c
services: docker

env:
  global:
    - DOCKERHUB_IMG=yhnw/openwrt-sdk
    - PKG_NAME=mackerel-agent
    - OPENWRT_GID=1000
    - QUIET=1 # 1: suppress build log / "": output all
  matrix:
    - DISTRO=openwrt-15.05.1 ARCH=ar71xx        PKG_DIR=bin/ar71xx/packages
    - DISTRO=lede-17.01.2    ARCH=ar71xx        PKG_DIR=bin/packages/mips_24kc
    - DISTRO=lede-17.01.2    ARCH=ramips-mt7620 PKG_DIR=bin/packages/mipsel_24kc
    - DISTRO=lede-17.01.2    ARCH=bcm53xx       PKG_DIR=bin/packages/arm_cortex-a9

before_install:
  - docker version
  - mkdir $PWD/pkgs
  - |
    if [[ "$(cat /etc/group | grep $OPENWRT_GID | wc -l)" == "0" ]]; then
        sudo groupadd -g $OPENWRT_GID openwrt
        sudo chgrp openwrt $PWD/pkgs
    else
        sudo chgrp "$(getent group $OPENWRT_GID | cut -d: -f1)" $PWD/pkgs
    fi
  - sudo chmod g+ws $PWD/pkgs

script:
  - docker run --rm -u openwrt -v $PWD:/work ${DOCKERHUB_IMG}:${DISTRO}-${ARCH} /bin/bash /work/build.sh ${DISTRO}-${ARCH} $PKG_DIR $PKG_NAME $QUIET
  - ls -la

after_failure:
  - if [[ -e pkgs/build.log ]]; then tail -300 pkgs/build.log; fi

deploy:
  - provider: releases
    api_key:
      secure: "EFwEWHzYIxjc4ymcwd0d+vyNbCde88hG+sIzwhWnMq4O695eeNesxg3Dx1pjTTuIHGVME5OZks294T09Zq9thf13PaSrR7Skv6qMoHFWs5qXgasATX1Ah1FPoBBXb+/r+8crflUCroFAOmtn8H3fZp6DYVg4ojYaMARMyWQvG3dmCU3JQQu7bDOOboqJZRGjBNJpzq4Q8Dd6kpuAi8sH2Lg/beZt70I4q6gZlrw1AJoS5VHVMxp6NFx9RqU7p64K/RRKX5gwC9VFkwsr5xTDraEjQm+uL6VSWBzBcEbEIMQJNfTHrlLcvFgRswuE664v8ArD2hsVyKM8vFaqJKIRciEc40L9Qxzw8YUFgn6LZWK9uyvirBXhYGCowuHojAxFcjYkz1TAXjowPcojdqTrYAeBp03gHUh+m/Fz/b5D64WBFSQ/S6sMvBjYzJ8mCGSQp2sUahTuf9jIQLD4pH2M0+5FfzVX4L/eTpXJaStIfVk5YJvzk3orsCdHpdJzV6s06aIjdeTlDlk9wrfjVdg1aYr1cTCvi9ly4HRhaN+gx6liHZ/Zky10h0eVuOpHnG9WCuWAhbD7Oj6DRxspkmVGxEs3y6Rinb3vt36drX+wpx3yzsavcn69Z6G+uJSFXjap98e0nlzMl2xa3d3tBmhX7/65pogYjVggAEa7iRVIg50="
    file_glob: true
    file: "pkgs/for-github/*.ipk"
    skip_cleanup: true
    on:
      tags: true
  - provider: gcs
    access_key_id: "GOOGZU4AGJJUVQ4DLX52"
    secret_access_key:
      secure: "fMhTjeCrbLuaWZZSYgyIPR2wi/acZ+TqSJDuZSjNkrvGO8dMvGoO2APeroNy+DH1YVMmiYVsgAL6iWvoUj04QKVlgo7Gl3ntxszYg1jD73k0Yf6IgEBGIltVYXVI0scX3ER7oj9u4rP4mJwMw4DkCfdNSTM9RB3uqV0V6SZuR3hsxhqQX3cbepNcYblfp7Tl+Es2dSm+Bln09RxvprMOS+pXKr44g7lRe8G78BZ5y2mVC4JOeLtMgDrCo4yAclGHcX3cAP+QUPW4oz2fKCa2Wmw6BOQKAXQBvfZBrPpVQGA59PzLODXnpU6VCPy4u4FInDA6YQKdTa7VoBv2QEcd3oGw6IVpg67BZfsvUn0FYCNNCMMo6EfmSaO276g1HYXStXgy4qXek+NOIJ7q/BMxp6iP4J/EshoOLXLP3mx2A8lUKY0A2LbLFFzJUS6IXhhh1doSEArDGE5AoBQppT6CJdqS7saqpLZK63hsOsVvsFJkTtEuKf8plruv9lDy6uCMJEzrIOW7FsTA7CWBN0fRxdAV8XQrGq5cDYiNOPLl1CZ/YFV/INXAmzXc4bw7Mtanuwl/6Ei9PPNMYbMmf/ZeKcjDVOK+3g3Nxew3CMMyilGJ5CATfhfiihlKt0jo9h4UhiJRRhu87NEmjUB4Cj2vQ73Q9oYZ3EKIXDtEGwm4fCg="
    bucket: "hnw-gcs-bucket-for-travis"
    skip_cleanup: true
    local-dir: pkgs/for-github/
    upload-dir: $(basename ${TRAVIS_REPO_SLUG})-${TRAVIS_BUILD_NUMBER}
    on:
      branch: master

jobs:
  include:
    -
      if: branch = master
      stage: Push release tag
      script: ./git-tag.sh
      deploy: []
